name: 'Terraform'

on:
  push:
    branches:
    - "development"
    paths:
     - 'Infrastructure/**'
  pull_request:

permissions:
  contents: read

jobs:
  terraform:
    name: 'Terraform'
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
    - name: Log in with Azure
      uses: azure/login@v1
      with:
        creds: '${{ secrets.AZURE_CREDENTIALS }}'
    - run: |
        az account subscription list
        
    # Checkout the repository to the GitHub Actions runner
    - name: Checkout
      uses: actions/checkout@v3
      with:
        repository: 'RajatAnand14/ProtivitiAzureTerraform'       
        ref: 'development'
        
    # Initialize a new or existing Terraform working directory by creating initial files, loading any remote state, downloading modules, etc.
    - name: Terraform Create Infrastructure
      working-directory: ./Infrastructure
      run: |
        export ARM_CLIENT_ID='${{ secrets.ARM_CLIENT_ID }}'
        export ARM_CLIENT_SECRET='${{ secrets.ARM_CLIENT_SECRET }}'
        export ARM_TENANT_ID='${{ secrets.ARM_TENANT_ID }}'
        export ARM_SUBSCRIPTION_ID='${{ secrets.ARM_SUBSCRIPTION_ID }}'
        terraform init
        terraform validate
        terraform plan -out "infra.tfplan"
        terraform apply "infra.tfplan"
        terraform output -raw tls_private_key 